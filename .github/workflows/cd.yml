name: iOS CD

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: "The version number of the release"
        required: true
permissions:
  contents: write

jobs:
  build:
    name: Build the binaries for the release and create a PR
    runs-on: macos-13

    steps:
      - name: setup xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '14.1'
      - name: Checkout OneSignal-iOS-SDK
        uses: actions/checkout@v3
      # - name: Bump Version Number
      #   run: |

      - name: Build Binaries
        run: |
          chmod +x ./../../iOS_SDK/OneSignalSDK/build_all_frameworks.sh
          ./../../iOS_SDK/OneSignalSDK/build_all_frameworks.sh
          # chmod +x ./../../iOS_SDK/OneSignalSDK/update_swift_package.sh
          # ./../../iOS_SDK/OneSignalSDK/update_swift_package.sh
        shell: bash
      - name: Commit Changes
        env:
          version: ${{ inputs.version }}
        run: |
          git config --local user.email "noreply@onesingal.com"
          git config --local user.name "SyncR ðŸ¤–"
          git add .
          git commit -m "Release $version"

      - name: Pushing changes
        uses: ad-m/github-push-action@master
        with:
          # github_token: ${{ secrets.ACTION_TOKEN_PAT }}
          repository: 'OneSignal/OneSignal-iOS-SDK'
          force: true
          branch: ${{ inputs.version }}

      - name: "Submitting PR"
        uses: octokit/request-action@v2.x
        with:
          route: POST /repos/{owner}/{repo}/pulls
          owner: OneSignal
          repo: OneSignal-iOS-SDK
          head: ${{ inputs.version }}
          base: main
          title: |
            "Release ${{ inputs.version }}"
          body: |
            "Add Release Notes For Review Here"
        # env:
        #   GITHUB_TOKEN: ${{ secrets.ACTION_TOKEN_PAT }}
